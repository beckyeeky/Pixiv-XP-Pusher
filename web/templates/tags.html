{% extends "base.html" %}

{% block title %}æ ‡ç­¾ç®¡ç† - Pixiv-XP-Pusher{% endblock %}

{% block extra_head %}
<style>
    .tags-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    
    @media (max-width: 768px) {
        .tags-container {
            grid-template-columns: 1fr;
        }
    }

    .search-box {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .search-input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .search-input-group input {
        flex: 1;
        padding: 0.6rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .search-input-group button {
        padding: 0.6rem 1rem;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .search-input-group button:hover {
        opacity: 0.9;
    }

    .weight-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .weight-control input {
        width: 60px;
        padding: 0.3rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--bg-primary);
        color: var(--text-primary);
        text-align: center;
    }

    .tag-result-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.6rem;
        margin-bottom: 0.4rem;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 6px;
        transition: background 0.2s;
    }

    .tag-result-item:hover {
        background: var(--accent-soft);
    }

    .tag-info {
        flex: 1;
    }

    .tag-name {
        font-weight: 500;
        color: var(--text-primary);
    }

    .tag-meta {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }

    .tag-actions {
        display: flex;
        gap: 0.3rem;
    }

    .tag-actions button {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .tag-actions button:hover {
        opacity: 0.8;
    }

    .btn-boost {
        background: #10b981;
        color: white;
    }

    .btn-block {
        background: #ef4444;
        color: white;
    }

    .btn-ip {
        background: #f59e0b;
        color: white;
    }

    .tag-chip.ip {
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.1);
    }

    .tag-chip.ip:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    .section-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.8rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border);
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        min-height: 40px;
    }

    .tag-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.3rem 0.6rem;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 16px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .tag-chip:hover {
        border-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    .tag-chip.boost {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.1);
    }

    .tag-chip.boost:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    .tag-chip .remove-icon {
        font-size: 0.7rem;
        opacity: 0.6;
    }

    .empty-state {
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-style: italic;
    }

    .search-results-container {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h2 class="card-title">ğŸ·ï¸ æ ‡ç­¾ç®¡ç†</h2>
    </div>
    <p style="color: var(--text-secondary); font-size: 0.9rem;">
        ç®¡ç†æ‚¨çš„ Boost Tagsï¼ˆæå‡æ¨èæƒé‡ï¼‰å’Œé»‘åå•ï¼ˆè¿‡æ»¤ä¸æƒ³è¦çš„æ ‡ç­¾ï¼‰ã€‚
    </p>
</div>

<div class="tags-container">
    <!-- å·¦ä¾§ï¼šå­—å…¸æŸ¥è¯¢ -->
    <div class="section-card">
        <div class="section-header">
            <span class="section-title">ğŸ“– XP å­—å…¸æŸ¥è¯¢</span>
        </div>
        
        <div class="search-box">
            <div class="search-input-group">
                <input type="text" id="tagSearchInput" placeholder="è¾“å…¥å…³é”®è¯ï¼ˆå¦‚ï¼šå¥³ä½“ã€ç™½é«ªã€thighsï¼‰">
                <button onclick="searchTag()">æœç´¢</button>
            </div>
            <div class="weight-control">
                <span>Boost å€ç‡:</span>
                <input type="number" id="boostWeight" value="1.5" step="0.1" min="1.0" max="5.0">
                <span>Ã—</span>
            </div>
        </div>

        <div id="searchResults" style="display: none;">
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                æœç´¢ç»“æœï¼ˆç‚¹å‡»å³ä¾§æŒ‰é’®æ“ä½œï¼‰
            </div>
            <div id="tagResultsList" class="search-results-container">
                <!-- Results will be populated here -->
            </div>
        </div>

        <div id="searchLoading" style="display: none; text-align: center; padding: 1rem; color: var(--text-secondary);">
            æœç´¢ä¸­...
        </div>
    </div>

    <!-- å³ä¾§ï¼šå·²è®¾ç½®æ ‡ç­¾ -->
    <div>
        <!-- Boost Tags -->
        <div class="section-card" style="margin-bottom: 1rem;">
            <div class="section-header">
                <span class="section-title">ğŸš€ Boost Tags</span>
                <span style="font-size: 0.8rem; color: var(--text-secondary);">æå‡æ¨èæƒé‡</span>
            </div>
            <div id="boostTagsList" class="tag-list">
                <span class="empty-state">æš‚æ—  Boost Tags</span>
            </div>
        </div>

        <!-- é»‘åå• -->
        <div class="section-card">
            <div class="section-header">
                <span class="section-title">ğŸš« é»‘åå•</span>
                <span style="font-size: 0.8rem; color: var(--text-secondary);">è¿‡æ»¤ç›¸å…³ä½œå“</span>
            </div>
            <div id="blacklistTagsList" class="tag-list">
                <span class="empty-state">æš‚æ— é»‘åå•æ ‡ç­¾</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// é¡µé¢åŠ è½½æ—¶è·å–å½“å‰è®¾ç½®
document.addEventListener('DOMContentLoaded', loadTagSettings);

function loadTagSettings() {
    // åŠ è½½ Boost Tags
    fetch('/api/config?section=profiler')
        .then(r => r.json())
        .then(data => {
            const boostTags = data.profiler?.boost_tags || {};
            const container = document.getElementById('boostTagsList');
            
            if (Object.keys(boostTags).length === 0) {
                container.innerHTML = '<span class="empty-state">æš‚æ—  Boost Tags</span>';
            } else {
                container.innerHTML = '';
                Object.entries(boostTags).forEach(([tag, multiplier]) => {
                    const chip = document.createElement('span');
                    // å¦‚æœå€ç‡å°äº1ï¼Œä½¿ç”¨ ip æ ·å¼ï¼ˆé™æƒï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ boost æ ·å¼
                    const isDownweight = multiplier < 1.0;
                    chip.className = isDownweight ? 'tag-chip ip' : 'tag-chip boost';
                    chip.innerHTML = `${tag} <span style="opacity:0.7">Ã—${multiplier}</span> <span class="remove-icon">âœ•</span>`;
                    chip.onclick = () => removeBoostTag(tag);
                    chip.title = `ç‚¹å‡»åˆ é™¤ ${tag}`;
                    container.appendChild(chip);
                });
            }
        })
        .catch(err => console.error('åŠ è½½ Boost Tags å¤±è´¥:', err));

    // åŠ è½½é»‘åå•
    fetch('/api/config?section=filter')
        .then(r => r.json())
        .then(data => {
            const blacklist = data.filter?.blacklist_tags || [];
            const container = document.getElementById('blacklistTagsList');
            
            if (blacklist.length === 0) {
                container.innerHTML = '<span class="empty-state">æš‚æ— é»‘åå•æ ‡ç­¾</span>';
            } else {
                container.innerHTML = '';
                blacklist.forEach(tag => {
                    const chip = document.createElement('span');
                    chip.className = 'tag-chip';
                    chip.innerHTML = `${tag} <span class="remove-icon">âœ•</span>`;
                    chip.onclick = () => removeBlacklistTag(tag);
                    chip.title = `ç‚¹å‡»åˆ é™¤ ${tag}`;
                    container.appendChild(chip);
                });
            }
        })
        .catch(err => console.error('åŠ è½½é»‘åå•å¤±è´¥:', err));
}

function searchTag() {
    const input = document.getElementById('tagSearchInput');
    const query = input.value.trim();
    
    if (!query) return;

    document.getElementById('searchLoading').style.display = 'block';
    document.getElementById('searchResults').style.display = 'none';

    fetch(`/api/search-tag?q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('searchLoading').style.display = 'none';
            
            if (data.success && data.results && data.results.length > 0) {
                const container = document.getElementById('tagResultsList');
                container.innerHTML = '';
                
                data.results.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'tag-result-item';
                    
                    const weight = item.weight || 0;
                    const weightText = weight > 0 ? weight.toFixed(1) : 'N/A';
                    
                    let tooltip = `æƒé‡: ${weightText}\næ¥æº: ${item.source}`;
                    if (item.original_tags && item.original_tags.length > 0) {
                        tooltip += `\nåŸå§‹æ ‡ç­¾: ${item.original_tags.join(', ')}`;
                    }
                    
                    div.innerHTML = `
                        <div class="tag-info">
                            <div class="tag-name">${item.tag}</div>
                            <div class="tag-meta">æƒé‡: ${weightText} | ${item.source}</div>
                        </div>
                        <div class="tag-actions">
                            <button class="btn-boost" onclick="addBoostTag('${item.tag}')">Boost</button>
                            <button class="btn-ip" onclick="addIpDownweight('${item.tag}')">é™æƒ</button>
                            <button class="btn-block" onclick="addBlacklistTag('${item.tag}')">å±è”½</button>
                        </div>
                    `;
                    div.title = tooltip;
                    container.appendChild(div);
                });
                
                document.getElementById('searchResults').style.display = 'block';
            } else {
                document.getElementById('tagResultsList').innerHTML = 
                    '<div style="color: var(--text-secondary); text-align: center; padding: 1rem;">æ— åŒ¹é…ç»“æœ</div>';
                document.getElementById('searchResults').style.display = 'block';
            }
        })
        .catch(err => {
            document.getElementById('searchLoading').style.display = 'none';
            console.error('æœç´¢å¤±è´¥:', err);
            alert('æœç´¢å¤±è´¥: ' + err.message);
        });
}

function addIpDownweight(tag) {
    if (!confirm(`ç¡®å®šè¦é™ä½ "${tag}" çš„æƒé‡å—ï¼Ÿ\nè¿™å°†ä½¿å…¶æ¨èé¢‘ç‡å¤§å¹…é™ä½ (0.1x)ã€‚`)) return;
    
    // é»˜è®¤é™æƒå€ç‡ 0.1
    const multiplier = 0.1;
    
    fetch('/api/config/boost-tag', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tag, multiplier})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadTagSettings();
        } else {
            alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(err => alert('ç½‘ç»œé”™è¯¯: ' + err.message));
}

function addBoostTag(tag) {
    const weight = parseFloat(document.getElementById('boostWeight').value) || 1.5;
    
    fetch('/api/config/boost-tag', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tag, multiplier: weight})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadTagSettings();
            // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆå¯é€‰ï¼‰
        } else {
            alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(err => alert('ç½‘ç»œé”™è¯¯: ' + err.message));
}

function removeBoostTag(tag) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ Boost Tag "${tag}" å—ï¼Ÿ`)) return;
    
    fetch('/api/config/boost-tag', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tag})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadTagSettings();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    });
}

function addBlacklistTag(tag) {
    fetch('/api/config/blacklist-tag', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tag})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadTagSettings();
        } else {
            alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(err => alert('ç½‘ç»œé”™è¯¯: ' + err.message));
}

function removeBlacklistTag(tag) {
    if (!confirm(`ç¡®å®šè¦ä»é»‘åå•ä¸­åˆ é™¤ "${tag}" å—ï¼Ÿ`)) return;
    
    fetch('/api/config/blacklist-tag', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tag})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadTagSettings();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
        }
    });
}

// å›è½¦é”®æœç´¢
document.getElementById('tagSearchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchTag();
    }
});
</script>
{% endblock %}