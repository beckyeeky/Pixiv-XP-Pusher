{% extends "base.html" %}

{% block title %}è®¾ç½® - Pixiv-XP-Pusher{% endblock %}

{% block extra_head %}
<style>
    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.2rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .form-control {
        width: 100%;
        padding: 0.8rem;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 0.95rem;
    }

    .form-control:focus {
        border-color: var(--accent);
        outline: none;
    }

    .btn-primary {
        background: var(--accent);
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        width: 100%;
        transition: opacity 0.2s;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }

    .btn-secondary {
        background: var(--bg-primary);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        padding: 0.6rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        margin-right: 0.5rem;
    }
    
    .btn-secondary:hover {
        border-color: var(--text-secondary);
        color: var(--text-primary);
    }

    .toggle-switch {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.8rem;
        background: var(--bg-primary);
        border-radius: 6px;
        border: 1px solid var(--border);
        cursor: pointer;
    }
    
    .toggle-switch input {
        width: 1.2rem;
        height: 1.2rem;
        cursor: pointer;
    }

    .range-wrap {
        padding: 0.5rem 0;
    }
    
    .range-value {
        float: right;
        color: var(--accent);
        font-weight: bold;
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        font-size: 0.8rem;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        color: var(--text-secondary);
    }

    /* Progress bar */
    .progress-container {
        display: none;
        margin-top: 1rem;
        background: var(--bg-primary);
        border-radius: 4px;
        height: 8px;
        overflow: hidden;
    }
    
    .progress-bar {
        height: 100%;
        background: var(--accent);
        width: 0%;
        transition: width 0.3s;
    }
    
    .log-area {
        margin-top: 1rem;
        background: #000;
        color: #0f0;
        font-family: monospace;
        padding: 0.8rem;
        border-radius: 6px;
        height: 150px;
        overflow-y: auto;
        font-size: 0.8rem;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="card-header">
    <h2 class="card-title">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
</div>

<form id="settingsForm">
<div class="settings-grid">
    
    <!-- 1. IP æ ‡ç­¾é™æƒ -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">ğŸ“‰ IP æ ‡ç­¾é™æƒ & åŒæ­¥</h3>
            <span class="status-badge" id="ipStatus">æœªåŒæ­¥</span>
        </div>
        
        <div class="form-group">
            <label class="form-label">
                é™æƒç³»æ•° (å½“å‰: <span id="discountValue" class="range-value">{{ config.profiler.ip_weight_discount | default(1.0) }}</span>)
                <br><small>0.1 = ä¸¥é‡é™æƒ (æ¨è), 1.0 = ä¸é™æƒ</small>
            </label>
            <div class="range-wrap">
                <input type="range" class="form-control" name="ip_weight_discount" 
                       min="0.1" max="1.0" step="0.1" 
                       value="{{ config.profiler.ip_weight_discount | default(1.0) }}"
                       oninput="document.getElementById('discountValue').innerText = this.value">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Danbooru Login (å¯é€‰)</label>
            <input type="text" class="form-control" name="danbooru_login" 
                   value="{{ config.profiler.danbooru_login | default('') }}" 
                   placeholder="ä½ çš„ç”¨æˆ·å">
        </div>
        
        <div class="form-group">
            <label class="form-label">Danbooru API Key (å¯é€‰)</label>
            <input type="password" class="form-control" name="danbooru_api_key" 
                   value="{{ config.profiler.danbooru_api_key | default('') }}" 
                   placeholder="ä½ çš„ API Key">
        </div>

        <button type="button" class="btn-secondary" onclick="syncIP()">ğŸ”„ ç«‹å³åŒæ­¥ IP åˆ—è¡¨</button>
        
        <div class="progress-container" id="syncProgress">
            <div class="progress-bar" id="syncBar"></div>
        </div>
        <div class="log-area" id="syncLog"></div>
    </div>

    <!-- 2. æ ¸å¿ƒç­–ç•¥ -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">ğŸ§© æ¨é€ç­–ç•¥å¼€å…³</h3>
        </div>
        
        <div class="form-group">
            {% set strategies = config.strategies %}
            <label class="toggle-switch">
                <input type="checkbox" name="strategies" value="xp_search" 
                       {% if 'xp_search' in strategies %}checked{% endif %}>
                <span>ğŸ” XP ç”»åƒæœç´¢ (æ ¸å¿ƒæ¨è)</span>
            </label>
        </div>
        
        <div class="form-group">
            <label class="toggle-switch">
                <input type="checkbox" name="strategies" value="related" 
                       {% if 'related' in strategies %}checked{% endif %}>
                <span>ğŸ”— å…³è”è¿é” (ç‚¹èµåæ¨èç›¸ä¼¼)</span>
            </label>
        </div>
        
        <div class="form-group">
            <label class="toggle-switch">
                <input type="checkbox" name="strategies" value="ranking" 
                       {% if 'ranking' in strategies %}checked{% endif %}>
                <span>ğŸ† æ¯æ—¥æ’è¡Œæ¦œ</span>
            </label>
        </div>
        
        <div class="form-group">
            <label class="toggle-switch">
                <input type="checkbox" name="strategies" value="subscription" 
                       {% if 'subscription' in strategies %}checked{% endif %}>
                <span>ğŸ‘¤ å…³æ³¨ç”»å¸ˆæ›´æ–°</span>
            </label>
        </div>
        
        <div class="form-group">
            <label class="form-label">R18 æ¨¡å¼</label>
            <select class="form-control" name="r18_mode">
                <option value="safe" {% if config.filter.r18_mode == 'safe' %}selected{% endif %}>Safe (ä»…å…¨å¹´é¾„)</option>
                <option value="mixed" {% if config.filter.r18_mode == 'mixed' %}selected{% endif %}>Mixed (æ··åˆ)</option>
                <option value="r18_only" {% if config.filter.r18_mode == 'r18_only' %}selected{% endif %}>R18 Only</option>
            </select>
        </div>
    </div>

    <!-- 3. XP å­—å…¸æŸ¥è¯¢ä¸å¿«é€Ÿæ“ä½œ -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">ğŸ“– XP å­—å…¸æŸ¥è¯¢ä¸å¿«é€Ÿæ“ä½œ</h3>
        </div>
        <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:1rem;">
            æœç´¢æ ‡ç­¾ï¼Œå¿«é€Ÿæ·»åŠ åˆ° Boost æˆ–é»‘åå•ã€‚
        </p>
        
        <div class="form-group" style="display:flex;gap:0.5rem;">
            <input type="text" id="tagSearchInput" class="form-control" placeholder="è¾“å…¥å…³é”®è¯ (å¦‚: å¥³ä½“)">
            <button type="button" class="btn-secondary" onclick="searchTag()">ğŸ”</button>
        </div>
        
        <div id="tagSearchResults" style="margin-top:1rem;display:none;">
            <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.5rem;">
                æœç´¢ç»“æœ (ç‚¹å‡»æ ‡ç­¾æŸ¥çœ‹è¯¦æƒ…ï¼Œå³ä¾§æŒ‰é’®å¿«é€Ÿæ“ä½œ)
            </div>
            <div id="tagResultsList">
                <!-- tags will go here -->
            </div>
        </div>
        
        <!-- å½“å‰è®¾ç½®å±•ç¤º -->
        <div style="margin-top:2rem;display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
            <!-- Boost Tags ç®¡ç† -->
            <div>
                <h4 style="margin-bottom:0.5rem;font-size:1rem;">ğŸš€ Boost Tags</h4>
                <div id="boostTagsList" class="tag-cloud">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </div>
                <div style="margin-top:0.5rem;font-size:0.85rem;color:var(--text-secondary);">
                    æƒé‡: <input type="number" id="boostWeight" value="1.5" step="0.1" min="1.0" max="5.0" style="width:60px;padding:0.2rem;">å€
                </div>
            </div>
            
            <!-- é»‘åå•ç®¡ç† -->
            <div>
                <h4 style="margin-bottom:0.5rem;font-size:1rem;">ğŸš« é»‘åå•</h4>
                <div id="blacklistTagsList" class="tag-cloud">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <!-- 4. åŸºç¡€è®¾ç½® -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">âš™ï¸ åŸºç¡€è®¾ç½®</h3>
        </div>
        
        <div class="form-group">
            <label class="form-label">Pixiv User ID</label>
            <input type="number" class="form-control" name="user_id" 
                   value="{{ config.pixiv.user_id }}">
        </div>
        
        <div class="form-group">
            <label class="form-label">å®šæ—¶ä»»åŠ¡ (Cron)</label>
            <input type="text" class="form-control" name="cron" 
                   value="{{ config.scheduler.cron }}" placeholder="0 12 * * *">
            <div style="margin-top: 0.5rem; font-size: 0.85rem;">
                <a href="#" onclick="setCron('0 12 * * *')">æ¯å¤©12ç‚¹</a> | 
                <a href="#" onclick="setCron('0 8,20 * * *')">æ—©8æ™š8</a> | 
                <a href="#" onclick="setCron('0 */4 * * *')">æ¯4å°æ—¶</a>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Proxy URL (Telegram)</label>
            <input type="text" class="form-control" name="proxy_url" 
                   value="{{ config.notifier.telegram.proxy_url | default('') }}"
                   placeholder="http://127.0.0.1:7890">
        </div>
    </div>

</div>

<div class="card" style="position: sticky; bottom: 20px; text-align: right; z-index: 100;">
    <span id="saveStatus" style="margin-right: 1rem; color: var(--text-secondary);"></span>
    <button type="submit" class="btn-primary" style="width: auto;">ğŸ’¾ ä¿å­˜é…ç½®å¹¶é‡å¯ç”Ÿæ•ˆ</button>
</div>
</form>

{% endblock %}

{% block extra_scripts %}
<script>
// XP å­—å…¸æŸ¥è¯¢
function searchTag() {
    const input = document.getElementById('tagSearchInput');
    const container = document.getElementById('tagSearchResults');
    const list = document.getElementById('tagResultsList');
    
    const q = input.value.trim();
    if (!q) return;
    
    console.log('æœç´¢æ ‡ç­¾:', q);
    
    // Clear list
    list.innerHTML = 'æœç´¢ä¸­...';
    container.style.display = 'block';
    
    fetch('/api/search-tag?q=' + encodeURIComponent(q))
    .then(r => {
        console.log('API å“åº”çŠ¶æ€:', r.status);
        if (!r.ok) {
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }
        return r.json();
    })
    .then(data => {
        console.log('API è¿”å›æ•°æ®:', data);
        list.innerHTML = '';
        if (data.success && data.results && data.results.length > 0) {
            data.results.forEach(item => {
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.justifyContent = 'space-between';
                container.style.marginBottom = '0.5rem';
                container.style.padding = '0.5rem';
                container.style.background = 'var(--bg-primary)';
                container.style.borderRadius = '6px';
                container.style.border = '1px solid var(--border)';
                
                // å·¦ä¾§ï¼šæ ‡ç­¾ä¿¡æ¯
                const tagInfo = document.createElement('div');
                tagInfo.style.flex = '1';
                
                const tagName = document.createElement('span');
                tagName.className = 'tag';
                tagName.style.cursor = 'pointer';
                tagName.style.marginRight = '0.5rem';
                
                const weight = item.weight || 0;
                const weightText = weight > 0 ? weight.toFixed(1) : 'N/A';
                
                let hint = '';
                if (item.original_match) {
                    hint = ' (é€šè¿‡åŸå§‹æ ‡ç­¾åŒ¹é…)';
                } else if (item.type === 'raw') {
                    hint = ' (åŸå§‹æ ‡ç­¾)';
                }
                
                tagName.innerHTML = `${item.tag} <span class="weight">${weightText}${hint}</span>`;
                
                // æ‚¬åœæç¤º
                let tooltip = `æ¥æº: ${item.source}, ç±»å‹: ${item.type}`;
                if (item.matched_original) {
                    tooltip += `\nåŒ¹é…çš„åŸå§‹æ ‡ç­¾: ${item.matched_original}`;
                }
                if (item.original_tags && item.original_tags.length > 0) {
                    tooltip += `\nå¯¹åº”åŸå§‹æ ‡ç­¾: ${item.original_tags.join(', ')}`;
                }
                tagName.title = tooltip;
                
                // ç‚¹å‡»æ ‡ç­¾æ˜¾ç¤ºè¯¦æƒ…
                tagName.onclick = () => {
                    alert(`æ ‡ç­¾: ${item.tag}\næƒé‡: ${weightText}\n${tooltip}`);
                };
                
                tagInfo.appendChild(tagName);
                container.appendChild(tagInfo);
                
                // å³ä¾§ï¼šæ“ä½œæŒ‰é’®
                const actions = document.createElement('div');
                actions.style.display = 'flex';
                actions.style.gap = '0.3rem';
                
                // Boost æŒ‰é’®
                const boostBtn = document.createElement('button');
                boostBtn.innerHTML = 'ğŸš€ Boost';
                boostBtn.style.padding = '0.3rem 0.6rem';
                boostBtn.style.fontSize = '0.8rem';
                boostBtn.style.background = 'var(--accent-soft)';
                boostBtn.style.border = '1px solid var(--accent)';
                boostBtn.style.borderRadius = '4px';
                boostBtn.style.cursor = 'pointer';
                boostBtn.onclick = (e) => {
                    e.stopPropagation();
                    addBoostTag(item.tag);
                };
                boostBtn.title = `æå‡ ${item.tag} çš„æ¨èæƒé‡`;
                
                // é»‘åå•æŒ‰é’®
                const blockBtn = document.createElement('button');
                blockBtn.innerHTML = 'ğŸš« å±è”½';
                blockBtn.style.padding = '0.3rem 0.6rem';
                blockBtn.style.fontSize = '0.8rem';
                blockBtn.style.background = 'var(--bg-primary)';
                blockBtn.style.border = '1px solid var(--border)';
                blockBtn.style.borderRadius = '4px';
                blockBtn.style.cursor = 'pointer';
                blockBtn.onclick = (e) => {
                    e.stopPropagation();
                    addBlacklistTag(item.tag);
                };
                blockBtn.title = `å±è”½åŒ…å« ${item.tag} æ ‡ç­¾çš„ä½œå“`;
                
                actions.appendChild(boostBtn);
                actions.appendChild(blockBtn);
                container.appendChild(actions);
                
                list.appendChild(container);
            });
        } else {
            let message = 'æ— åŒ¹é…ç»“æœ';
            if (data.error) {
                message = `é”™è¯¯: ${data.error}`;
            } else if (!data.success) {
                message = 'æœç´¢å¤±è´¥';
            }
            list.innerHTML = `<span style="color:var(--text-secondary)">${message}</span>`;
        }
    })
    .catch(err => {
        console.error('æœç´¢å¤±è´¥:', err);
        list.innerHTML = 'âŒ æœç´¢å¤±è´¥: ' + err.message;
    });
}

function setCron(val) {
    document.querySelector('input[name="cron"]').value = val;
    return false;
}

// åŠ è½½å½“å‰è®¾ç½®
function loadCurrentSettings() {
    // åŠ è½½ Boost Tags
    fetch('/api/config?section=profiler')
        .then(r => r.json())
        .then(data => {
            const boostTags = data.profiler?.boost_tags || {};
            const boostList = document.getElementById('boostTagsList');
            boostList.innerHTML = '';
            
            for (const [tag, multiplier] of Object.entries(boostTags)) {
                const el = document.createElement('span');
                el.className = 'tag';
                el.innerHTML = `${tag} <span class="weight">Ã—${multiplier}</span>`;
                el.style.cursor = 'pointer';
                el.title = `ç‚¹å‡»åˆ é™¤ ${tag}`;
                el.onclick = () => removeBoostTag(tag);
                boostList.appendChild(el);
            }
            
            if (Object.keys(boostTags).length === 0) {
                boostList.innerHTML = '<span style="color:var(--text-secondary);font-size:0.9rem;">æš‚æ—  Boost Tags</span>';
            }
        });
    
    // åŠ è½½é»‘åå•
    fetch('/api/config?section=filter')
        .then(r => r.json())
        .then(data => {
            const blacklist = data.filter?.blacklist_tags || [];
            const blacklistEl = document.getElementById('blacklistTagsList');
            blacklistEl.innerHTML = '';
            
            blacklist.forEach(tag => {
                const el = document.createElement('span');
                el.className = 'tag';
                el.innerHTML = tag;
                el.style.cursor = 'pointer';
                el.title = `ç‚¹å‡»åˆ é™¤ ${tag}`;
                el.onclick = () => removeBlacklistTag(tag);
                blacklistEl.appendChild(el);
            });
            
            if (blacklist.length === 0) {
                blacklistEl.innerHTML = '<span style="color:var(--text-secondary);font-size:0.9rem;">æš‚æ— é»‘åå•æ ‡ç­¾</span>';
            }
        });
}

// æ·»åŠ  Boost Tag
function addBoostTag(tag) {
    const weight = parseFloat(document.getElementById('boostWeight').value) || 1.5;
    
    fetch('/api/config/boost-tag', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tag, multiplier: weight})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(`âœ… å·²æ·»åŠ  Boost: ${tag} Ã—${weight}`);
            loadCurrentSettings();
        } else {
            alert(`âŒ æ·»åŠ å¤±è´¥: ${data.error}`);
        }
    })
    .catch(err => {
        alert(`âŒ ç½‘ç»œé”™è¯¯: ${err.message}`);
    });
}

// åˆ é™¤ Boost Tag
function removeBoostTag(tag) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ Boost Tag: ${tag} å—ï¼Ÿ`)) return;
    
    fetch('/api/config/boost-tag', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tag})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadCurrentSettings();
        } else {
            alert(`âŒ åˆ é™¤å¤±è´¥: ${data.error}`);
        }
    });
}

// æ·»åŠ é»‘åå•æ ‡ç­¾
function addBlacklistTag(tag) {
    fetch('/api/config/blacklist-tag', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tag})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(`âœ… å·²æ·»åŠ åˆ°é»‘åå•: ${tag}`);
            loadCurrentSettings();
        } else {
            alert(`âŒ æ·»åŠ å¤±è´¥: ${data.error}`);
        }
    });
}

// åˆ é™¤é»‘åå•æ ‡ç­¾
function removeBlacklistTag(tag) {
    if (!confirm(`ç¡®å®šè¦ä»é»‘åå•ä¸­åˆ é™¤: ${tag} å—ï¼Ÿ`)) return;
    
    fetch('/api/config/blacklist-tag', {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tag})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadCurrentSettings();
        } else {
            alert(`âŒ åˆ é™¤å¤±è´¥: ${data.error}`);
        }
    });
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadCurrentSettings();
});

// æ£€æŸ¥ IP åŒæ­¥çŠ¶æ€
fetch('/api/sync-status')
    .then(r => r.json())
    .then(data => {
        const el = document.getElementById('ipStatus');
        if (data.exists) {
            el.innerText = `âœ… å·²åŒæ­¥ (${data.count} ä¸ªæ ‡ç­¾, ${data.mtime})`;
            el.style.color = '#4caf50';
            el.style.borderColor = '#4caf50';
        } else {
            el.innerText = 'âš ï¸ æœªåŒæ­¥';
            el.style.color = '#ff9800';
            el.style.borderColor = '#ff9800';
        }
    });

// è§¦å‘åŒæ­¥
function syncIP() {
    const btn = document.querySelector('button[onclick="syncIP()"]');
    const progress = document.getElementById('syncProgress');
    const bar = document.getElementById('syncBar');
    const log = document.getElementById('syncLog');
    const form = document.getElementById('settingsForm');
    
    // è·å–å½“å‰å¡«å†™çš„å‡­è¯
    const formData = new FormData(form);
    
    if (!confirm('ç¡®å®šè¦å¼€å§‹åŒæ­¥ Danbooru IP æ ‡ç­¾å—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿã€‚')) return;
    
    btn.disabled = true;
    btn.innerText = 'â³ åŒæ­¥ä¸­...';
    progress.style.display = 'block';
    log.style.display = 'block';
    log.innerText = 'æ­£åœ¨å¯åŠ¨åŒæ­¥è¿›ç¨‹...\n';
    
    // ç®€å•æ¨¡æ‹Ÿè¿›åº¦æ¡åŠ¨ç”»
    let width = 0;
    const interval = setInterval(() => {
        if (width >= 90) return;
        width += 5;
        bar.style.width = width + '%';
    }, 500);

    fetch('/api/sync-ip', {
        method: 'POST',
        body: JSON.stringify(Object.fromEntries(formData)),
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        clearInterval(interval);
        bar.style.width = '100%';
        btn.disabled = false;
        btn.innerText = 'ğŸ”„ ç«‹å³åŒæ­¥ IP åˆ—è¡¨';
        
        log.innerText += data.output;
        if (data.success) {
            alert('åŒæ­¥æˆåŠŸï¼åˆ·æ–°é¡µé¢æŸ¥çœ‹çŠ¶æ€ã€‚');
            location.reload();
        } else {
            alert('åŒæ­¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ã€‚');
        }
    })
    .catch(err => {
        clearInterval(interval);
        btn.disabled = false;
        log.innerText += '\nâŒ è¯·æ±‚å¤±è´¥: ' + err;
    });
}

// ä¿å­˜é…ç½®
document.getElementById('settingsForm').onsubmit = function(e) {
    e.preventDefault();
    const btn = document.querySelector('button[type="submit"]');
    const status = document.getElementById('saveStatus');
    
    // æ”¶é›† checkbox æ•°ç»„
    const strategies = [];
    document.querySelectorAll('input[name="strategies"]:checked').forEach(el => {
        strategies.push(el.value);
    });
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    data.strategies = strategies; // è¦†ç›– checkbox çš„å•ä¸€å€¼
    
    btn.disabled = true;
    btn.innerText = 'ä¿å­˜ä¸­...';
    
    fetch('/api/settings', {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(res => {
        btn.disabled = false;
        btn.innerText = 'ğŸ’¾ ä¿å­˜é…ç½®å¹¶é‡å¯ç”Ÿæ•ˆ';
        if (res.success) {
            status.innerText = 'âœ… ä¿å­˜æˆåŠŸ';
            setTimeout(() => status.innerText = '', 3000);
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + res.error);
        }
    });
};
</script>
{% endblock %}