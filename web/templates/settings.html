{% extends "base.html" %}

{% block title %}è®¾ç½® - Pixiv-XP-Pusher{% endblock %}

{% block extra_head %}
<style>
    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 1.5rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .form-group {
        margin-bottom: 1.2rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .form-control {
        width: 100%;
        padding: 0.7rem;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 0.95rem;
    }

    .form-control:focus {
        border-color: var(--accent);
        outline: none;
    }

    .btn-primary {
        background: var(--accent);
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: opacity 0.2s;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }

    .btn-secondary {
        background: var(--bg-primary);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .btn-secondary:hover {
        border-color: var(--accent);
        color: var(--accent);
    }

    .toggle-switch {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 0.7rem;
        background: var(--bg-primary);
        border-radius: 6px;
        border: 1px solid var(--border);
        cursor: pointer;
        margin-bottom: 0.5rem;
    }

    .toggle-switch:hover {
        border-color: var(--accent-soft);
    }

    .toggle-switch input {
        width: 1.1rem;
        height: 1.1rem;
        cursor: pointer;
    }

    .range-wrap {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .range-wrap input[type="range"] {
        flex: 1;
    }

    .range-value {
        min-width: 50px;
        text-align: center;
        color: var(--accent);
        font-weight: bold;
        font-size: 1.1rem;
    }

    .status-badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        font-size: 0.8rem;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        color: var(--text-secondary);
    }

    .help-text {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 0.3rem;
    }

    .section-divider {
        border-top: 1px solid var(--border);
        margin: 1.5rem 0;
    }

    .save-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border);
        padding: 1rem 2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        z-index: 100;
    }

    .save-bar .btn-primary {
        width: auto;
        padding: 0.7rem 2rem;
    }

    .sync-log {
        background: #000;
        color: #0f0;
        font-family: monospace;
        padding: 0.8rem;
        border-radius: 6px;
        height: 120px;
        overflow-y: auto;
        font-size: 0.75rem;
        margin-top: 0.8rem;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding-bottom: 80px;">
    
    <div class="card" style="margin-bottom: 1.5rem;">
        <div class="card-header">
            <h2 class="card-title">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
        </div>
        <p style="color: var(--text-secondary); font-size: 0.9rem;">
            é…ç½®æ¨é€ç­–ç•¥ã€IP é™æƒã€å®šæ—¶ä»»åŠ¡ç­‰ç³»ç»Ÿå‚æ•°ã€‚
            <a href="/tags" style="color: var(--accent);">ç®¡ç† Tags è¯·å» Tags é¡µé¢ â†’</a>
        </p>
    </div>

    <form id="settingsForm">
    <div class="settings-grid">
        
        <!-- IP é™æƒè®¾ç½® -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ğŸ“‰ IP æ ‡ç­¾é™æƒ</h3>
                <span class="status-badge" id="ipStatus">æ£€æŸ¥ä¸­...</span>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    é™æƒç³»æ•°
                    <span class="range-value" id="discountValue">{{ config.profiler.ip_weight_discount | default(1.0) }}</span>
                </label>                
                <div class="range-wrap">
                    <input type="range" name="ip_weight_discount" 
                           min="0.1" max="1.0" step="0.1" 
                           value="{{ config.profiler.ip_weight_discount | default(1.0) }}"
                           oninput="document.getElementById('discountValue').innerText = this.value">
                </div>
                <div class="help-text">
                    0.1 = é™æƒ 90%ï¼ˆIP æ ‡ç­¾å‡ ä¹ä¸å‡ºç°ï¼‰ï¼Œ1.0 = ä¸é™æƒ
                </div>
            </div>

            <div class="section-divider"></div>

            <div class="form-group">
                <label class="form-label">Danbooru ç”¨æˆ·å</label>
                <input type="text" class="form-control" name="danbooru_login" 
                       value="{{ config.profiler.danbooru_login | default('') }}" 
                       placeholder="é€‰å¡«ï¼Œç”¨äºåŒæ­¥ IP æ ‡ç­¾">
            </div>
            
            <div class="form-group">
                <label class="form-label">Danbooru API Key</label>
                <input type="password" class="form-control" name="danbooru_api_key" 
                       value="{{ config.profiler.danbooru_api_key | default('') }}" 
                       placeholder="é€‰å¡«">
                <div class="help-text">
                    <a href="https://danbooru.donmai.us/profile/api_key" target="_blank" style="color: var(--accent);">è·å– API Key</a>
                </div>
            </div>

            <button type="button" class="btn-secondary" onclick="syncIP()">
                ğŸ”„ åŒæ­¥ IP æ ‡ç­¾åˆ—è¡¨
            </button>
            
            <div class="sync-log" id="syncLog"></div>
        </div>

        <!-- æ¨é€ç­–ç•¥ -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ğŸ§© æ¨é€ç­–ç•¥</h3>
            </div>
            
            <div class="form-group">
                <label class="toggle-switch">
                    <input type="checkbox" name="strategies" value="xp_search" 
                           {% if 'xp_search' in config.strategies %}checked{% endif %}>
                    <span>ğŸ” XP ç”»åƒæœç´¢</span>
                </label>
                
                <label class="toggle-switch">
                    <input type="checkbox" name="strategies" value="related" 
                           {% if 'related' in config.strategies %}checked{% endif %}>
                    <span>ğŸ”— å…³è”è¿é”</span>
                </label>
                
                <label class="toggle-switch">
                    <input type="checkbox" name="strategies" value="ranking" 
                           {% if 'ranking' in config.strategies %}checked{% endif %}>
                    <span>ğŸ† æ¯æ—¥æ’è¡Œæ¦œ</span>
                </label>
                
                <label class="toggle-switch">
                    <input type="checkbox" name="strategies" value="subscription" 
                           {% if 'subscription' in config.strategies %}checked{% endif %}>
                    <span>ğŸ‘¤ å…³æ³¨ç”»å¸ˆæ›´æ–°</span>
                </label>
            </div>

            <div class="section-divider"></div>

            <div class="form-group">
                <label class="form-label">R18 æ¨¡å¼</label>
                <select class="form-control" name="r18_mode">
                    <option value="safe" {% if config.filter.r18_mode == 'safe' %}selected{% endif %}>Safe (ä»…å…¨å¹´é¾„)</option>
                    <option value="mixed" {% if config.filter.r18_mode == 'mixed' %}selected{% endif %}>Mixed (æ··åˆ)</option>
                    <option value="r18_only" {% if config.filter.r18_mode == 'r18_only' %}selected{% endif %}>R18 Only</option>
                </select>
            </div>
        </div>

        <!-- åŸºç¡€è®¾ç½® -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">âš™ï¸ åŸºç¡€é…ç½®</h3>
            </div>
            
            <div class="form-group">
                <label class="form-label">Pixiv User ID</label>
                <input type="number" class="form-control" name="user_id" 
                       value="{{ config.pixiv.user_id | default('') }}"
                       placeholder="ç”¨äºåˆ†ææ”¶è—æ„å»ºç”»åƒ">
            </div>
            
            <div class="form-group">
                <label class="form-label">å®šæ—¶ä»»åŠ¡ (Cron)</label>
                <input type="text" class="form-control" name="cron" 
                       value="{{ config.scheduler.cron | default('0 12 * * *') }}"
                       placeholder="0 12 * * *">
                <div class="help-text" style="margin-top: 0.5rem;">
                    <a href="#" onclick="setCron('0 12 * * *')">æ¯å¤©12ç‚¹</a> Â·
                    <a href="#" onclick="setCron('0 8,20 * * *')">æ—©8æ™š8</a> Â·
                    <a href="#" onclick="setCron('0 */4 * * *')">æ¯4å°æ—¶</a>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Telegram Proxy</label>
                <input type="text" class="form-control" name="proxy_url" 
                       value="{{ config.notifier.telegram.proxy_url | default('') }}"
                       placeholder="http://127.0.0.1:7890">
                <div class="help-text">å›½å†…ç”¨æˆ·éœ€å¡«å†™ï¼Œç”¨äºè¿æ¥ Telegram</div>
            </div>
        </div>

    </div>
    </form>

    <!-- å›ºå®šåº•éƒ¨ä¿å­˜æ  -->
    <div class="save-bar">
        <span id="saveStatus" style="color: var(--text-secondary);"></span>
        <button type="button" class="btn-primary" onclick="saveSettings()">
            ğŸ’¾ ä¿å­˜é…ç½®
        </button>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
// è®¾ç½® Cron é¢„è®¾
function setCron(val) {
    document.querySelector('input[name="cron"]').value = val;
    return false;
}

// æ£€æŸ¥ IP åŒæ­¥çŠ¶æ€
fetch('/api/sync-status')
    .then(r => r.json())
    .then(data => {
        const el = document.getElementById('ipStatus');
        if (data.exists) {
            el.innerText = `âœ… å·²åŒæ­¥ (${data.count})`;
            el.style.color = '#4caf50';
            el.style.borderColor = '#4caf50';
        } else {
            el.innerText = 'âš ï¸ æœªåŒæ­¥';
            el.style.color = '#ff9800';
            el.style.borderColor = '#ff9800';
        }
    })
    .catch(() => {
        document.getElementById('ipStatus').innerText = 'âŒ æ£€æŸ¥å¤±è´¥';
    });

// åŒæ­¥ IP æ ‡ç­¾
function syncIP() {
    const btn = event.target;
    const log = document.getElementById('syncLog');
    
    if (!confirm('å¼€å§‹åŒæ­¥ Danbooru IP æ ‡ç­¾ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿã€‚')) return;
    
    btn.disabled = true;
    btn.innerText = 'â³ åŒæ­¥ä¸­...';
    log.style.display = 'block';
    log.innerText = 'æ­£åœ¨å¯åŠ¨...\n';
    
    const login = document.querySelector('input[name="danbooru_login"]').value;
    const apiKey = document.querySelector('input[name="danbooru_api_key"]').value;
    
    fetch('/api/sync-ip', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            danbooru_login: login,
            danbooru_api_key: apiKey
        })
    })
    .then(r => r.json())
    .then(data => {
        log.innerText += data.output || '';
        
        if (data.success) {
            alert('âœ… åŒæ­¥æˆåŠŸï¼');
            location.reload();
        } else {
            alert('âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—');
        }
    })
    .catch(err => {
        log.innerText += '\nâŒ é”™è¯¯: ' + err.message;
        alert('è¯·æ±‚å¤±è´¥: ' + err.message);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerText = 'ğŸ”„ åŒæ­¥ IP æ ‡ç­¾åˆ—è¡¨';
    });
}

// ä¿å­˜è®¾ç½®
function saveSettings() {
    const btn = document.querySelector('.save-bar .btn-primary');
    const status = document.getElementById('saveStatus');
    const form = document.getElementById('settingsForm');
    
    // æ”¶é›†ç­–ç•¥ checkbox
    const strategies = [];
    form.querySelectorAll('input[name="strategies"]:checked').forEach(el => {
        strategies.push(el.value);
    });
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.strategies = strategies;
    
    btn.disabled = true;
    btn.innerText = 'ä¿å­˜ä¸­...';
    
    fetch('/api/settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            status.innerText = 'âœ… ä¿å­˜æˆåŠŸ';
            status.style.color = '#4caf50';
        } else {
            status.innerText = 'âŒ ä¿å­˜å¤±è´¥';
            status.style.color = '#ef4444';
            alert('ä¿å­˜å¤±è´¥: ' + (res.error || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(err => {
        status.innerText = 'âŒ ç½‘ç»œé”™è¯¯';
        status.style.color = '#ef4444';
        alert('ç½‘ç»œé”™è¯¯: ' + err.message);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerText = 'ğŸ’¾ ä¿å­˜é…ç½®';
        setTimeout(() => {
            status.innerText = '';
        }, 3000);
    });
}
</script>
{% endblock %}